<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>UK Days Out Map</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">

  <style>
    body{
      margin:0;
      font-family:Inter,sans-serif;
      background:#f6f6db;
      color:#222;
      overflow:hidden;
    }
    header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:1rem;
      background:#f6f6db;
      border-bottom:1px solid #444;
      z-index:9999;
      position:relative;
    }
    #map{
      position:absolute;
      top:60px; bottom:0; left:0; right:0;
    }

    /* search */
    #searchBox{
      position:absolute;
      top:80px; left:70px;
      width:260px;
      z-index:9999;
    }
    #searchInput{
      width:100%;
      padding:10px;
      border:1px solid #444;
      border-radius:8px 8px 0 0;
      background:#fff;
      font-size:14px;
    }
    #suggest{
      background:#fff;
      border:1px solid #444;
      border-top:none;
      display:none;
      max-height:240px;
      overflow:auto;
      border-radius:0 0 8px 8px;
    }
    #suggest div{
      padding:8px;
      cursor:pointer;
    }
    #suggest div:hover{
      background:#eee;
    }

    /* radius */
    #radiusBox{
      position:absolute;
      top:160px; left:70px;
      width:260px;
      padding:10px;
      background:#fff;
      border:1px solid #444;
      border-radius:8px;
      z-index:9999;
      display:none;
      font-size:14px;
    }

    /* side panel */
    #sidePanel{
      position:absolute;
      right:0; top:0;
      width:340px; height:100vh;
      background:#fff;
      border-left:1px solid #444;
      z-index:10000;
      padding:16px;
      overflow:auto;
      display:none;
    }
    #sidePanel h2{
      margin-top:0;
    }
    .sideImage{
      width:100%;
      border-radius:8px;
      margin-bottom:12px;
      object-fit:cover;
      max-height:200px;
    }
    .btn{
      display:inline-block;
      padding:8px 12px;
      border:1px solid #444;
      border-radius:6px;
      background:#fff;
      font-size:14px;
      margin:6px 4px 0 0;
      cursor:pointer;
    }

    /* expand button floating */
    #expandBtn{
      position:absolute;
      bottom:20px; right:20px;
      z-index:9999;
      padding:10px 14px;
      border-radius:6px;
      background:#fff;
      border:1px solid #444;
      font-size:14px;
      cursor:pointer;
      display:none;
    }

    @media(max-width:700px){
      #searchBox{left:10px; width:85vw;}
      #radiusBox{left:10px; width:85vw;}
      #sidePanel{width:100vw;}
    }
  </style>
</head>
<body>

<header>
  <div>UK Days Out Map</div>
</header>

<div id="map"></div>

<!-- Search -->
<div id="searchBox">
  <input id="searchInput" placeholder="Search attractions or postcode"/>
  <div id="suggest"></div>
</div>

<!-- Radius -->
<div id="radiusBox">
  <div>Centre: <span id="centerLabel">â€”</span></div>
  <div>Radius: <span id="radiusVal">25</span> km</div>
  <input id="radius" type="range" min="1" max="200" value="25"/>
  <div style="margin-top:8px">
    <button id="listNearby" class="btn">List nearby</button>
    <button id="clearRadius" class="btn">Clear</button>
  </div>
</div>

<!-- Side panel -->
<div id="sidePanel"></div>

<!-- Expand button -->
<button id="expandBtn">See more</button>

<script>
/* Map */
const map = L.map("map").setView([54.5,-3.5],6);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"&copy; OpenStreetMap"}).addTo(map);

/* State */
let attractions=[];
let stations=[];
const markers={};
let centerLocation=null;
let circleLayer=null;

/* UI */
const input=document.getElementById("searchInput");
const suggest=document.getElementById("suggest");
const radiusBox=document.getElementById("radiusBox");
const radiusInput=document.getElementById("radius");
const radiusVal=document.getElementById("radiusVal");
const centerLabel=document.getElementById("centerLabel");
const sidePanel=document.getElementById("sidePanel");
const expandBtn=document.getElementById("expandBtn");
const listNearbyBtn=document.getElementById("listNearby");
const clearRadiusBtn=document.getElementById("clearRadius");

/* Tools */
function hdist(lat1,lon1,lat2,lon2){
  const R=6371, toRad=d=>d*Math.PI/180;
  const dLat=toRad(lat2-lat1), dLon=toRad(lon2-lon1);
  const a=Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
  return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
}
function stName(s){return s.stationName||s.name||"Unknown";}

/* Fetch Wikipedia image if missing */
async function fetchWikiImage(title){
  try{
    const url = "https://en.wikipedia.org/w/api.php?" +
      new URLSearchParams({
        action:"query",
        prop:"pageimages",
        piprop:"original",
        format:"json",
        origin:"*",
        titles:title
      }).toString();

    const r = await fetch(url);
    const j = await r.json();
    const pages = j?.query?.pages;
    if(!pages) return null;
    const page = Object.values(pages)[0];
    return page?.original?.source || null;
  }catch(e){
    console.warn("Wiki image error",e);
    return null;
  }
}

/* Expand popup link */
function setExpandFor(a){
  expandBtn.style.display="block";
  expandBtn.onclick=()=>showPanel(a);
}

/* Show right panel */
async function showPanel(a){
  let imgURL = a.image || null;
  if(!imgURL){
    imgURL = await fetchWikiImage(a.name);
  }
  const imgHTML = imgURL ? `<img class="sideImage" src="${imgURL}"/>` : "";

  let nsTxt = a.nearestStation || "";
  if(stations.length){
    let best=null, bestDist=1e99;
    stations.forEach(s=>{
      const sl=Number(s.lat), lg=Number(s.long ?? s.lng);
      if(!Number.isFinite(sl)||!Number.isFinite(lg))return;
      const d=hdist(a.lat,a.lng,sl,lg);
      if(d<bestDist){bestDist=d;best=s;}
    });
    if(best) nsTxt=`${stName(best)} (${bestDist.toFixed(1)} km)`;
  }

  sidePanel.style.display="block";
  sidePanel.innerHTML=`
    <h2>${a.name}</h2>
    ${imgHTML}
    <p>${a.description || ""}</p>
    <p><b>Nearest station:</b> ${nsTxt}</p>
    <p><a href="${a.website || "#"}" target="_blank">Website</a></p>
    <div>
      <button class="btn" onclick="map.flyTo([${a.lat},${a.lng}],13);markers['${a.id}'].openPopup();">Take me there</button>
      <a class="btn"
         target="_blank"
         href="https://ojp.nationalrail.co.uk/service/timesandfares/?tto=${encodeURIComponent(a.nearestStation||'')}">
         Train
      </a>
      <a class="btn"
         target="_blank"
         href="https://www.google.com/maps/search/?api=1&query=${a.lat},${a.lng}">
         Google Maps
      </a>
      <button class="btn" onclick="sidePanel.style.display='none'">Close</button>
    </div>
  `;
}

/* Go to attraction */
function gotoA(a){
  map.flyTo([a.lat,a.lng],13);
  markers[a.id].openPopup();
  setExpandFor(a);
}

/* Suggestion UI */
function showSuggest(list){
  if(!list.length){suggest.style.display="none";return;}
  suggest.innerHTML="";
  list.slice(0,10).forEach(a=>{
    const d=document.createElement("div");
    d.textContent=a.name;
    d.onclick=(()=>{
      suggest.style.display="none";
      gotoA(a);
    });
    suggest.appendChild(d);
  });
  suggest.style.display="block";
}
function searchName(t){
  t=t.trim().toLowerCase();
  return attractions.filter(a=>a.name.toLowerCase().includes(t));
}

/* Geocode */
async function geocode(q){
  const url="https://nominatim.openstreetmap.org/search?format=json&q="+encodeURIComponent(q);
  const r=await fetch(url);
  if(!r.ok)return null;
  const d=await r.json();
  return d?.length?{lat:Number(d[0].lat),lng:Number(d[0].lon),label:d[0].display_name}:null;
}

/* Radius search */
function radiusSearch(){
  if(!centerLocation)return;
  const km=Number(radiusInput.value);

  if(circleLayer) map.removeLayer(circleLayer);
  circleLayer=L.circle([centerLocation.lat,centerLocation.lng],
    {radius:km*1000,color:"#157a18",fill:false}).addTo(map);

  const out=attractions.filter(a=>hdist(centerLocation.lat,centerLocation.lng,a.lat,a.lng)<=km);
  map.fitBounds(circleLayer.getBounds(),{padding:[40,40]});
  if(out.length) listShows(out);
}

function listShows(list){
  sidePanel.style.display="block";
  sidePanel.innerHTML="<h2>Results</h2>";
  list.forEach(a=>{
    const el=document.createElement("div");
    el.style.padding="8px";
    el.style.borderBottom="1px solid #ddd";
    el.style.cursor="pointer";
    el.textContent=a.name;
    el.onclick=(()=>gotoA(a));
    sidePanel.appendChild(el);
  });
  const x=document.createElement("button");
  x.textContent="Close";
  x.className="btn";
  x.onclick=(()=>sidePanel.style.display="none");
  sidePanel.appendChild(x);
}

/* Input handlers */
input.oninput=()=>{
  const t=input.value;
  if(!t){suggest.style.display="none";return;}
  showSuggest(searchName(t));
};

input.onkeydown=async e=>{
  if(e.key==="Enter"){
    e.preventDefault();
    const t=input.value.trim();
    if(!t)return;
    const m=searchName(t);
    if(m.length){gotoA(m[0]);return;}
    const g=await geocode(t);
    if(!g){alert("Not found");return;}
    centerLocation=g;
    centerLabel.textContent=g.label.split(",")[0];
    radiusBox.style.display="block";
    radiusSearch();
  }
};

radiusInput.oninput=()=>{
  radiusVal.textContent=radiusInput.value;
  radiusSearch();
};

listNearbyBtn.onclick=()=>radiusSearch();

clearRadiusBtn.onclick=()=>{
  centerLocation=null;
  radiusBox.style.display="none";
  if(circleLayer) map.removeLayer(circleLayer);
  sidePanel.style.display="none";
};

/* Load data */
Promise.all([
  fetch("attractions.json").then(r=>r.json()),
  fetch("stations.json").then(r=>r.json())
]).then(([A,S])=>{
  attractions=Array.isArray(A)?A:[A];
  stations=Array.isArray(S)?S:[S];

  attractions.forEach(a=>{
    if(a.lng===undefined && a.long!==undefined) a.lng=a.long;
    const m=L.marker([a.lat,a.lng]).addTo(map);

    markers[a.id]=m;
    m.bindPopup(`<b>${a.name}</b><br><button onclick="window._expand('${a.id}')">See more</button>`);
    m.on("click",()=>setExpandFor(a));
  });

  window._expand=id=>{
    const a=attractions.find(x=>x.id===id);
    if(a) showPanel(a);
  };
});
</script>

</body>
</html>
